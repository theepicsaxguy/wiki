---
// Pagefind Search Component - Static Site Search
---

<div id="pagefind-search" class="mb-6">
  <div id="search-input-container" class="relative">
    <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
      <svg class="w-5 h-5 text-slate-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z" />
      </svg>
    </div>
    <input
      id="pagefind-search-input"
      type="search"
      placeholder="Search documentation..."
      class="w-full pl-10 pr-4 py-2.5 bg-[#1e232f] border border-[#292e3b] rounded-lg text-sm text-white placeholder-slate-400 focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:border-transparent transition-all"
    />
  </div>
  <div id="pagefind-results" class="mt-3 space-y-2 max-h-96 overflow-y-auto hidden"></div>
</div>

<script>
  // Load Pagefind only in production builds
  if (import.meta.env.PROD) {
    // Dynamically load Pagefind UI
    const loadPagefind = async () => {
      // @ts-ignore
      const pagefind = await import('/pagefind/pagefind.js');
      await pagefind.init();
      return pagefind;
    };

    const searchInput = document.getElementById('pagefind-search-input') as HTMLInputElement;
    const resultsContainer = document.getElementById('pagefind-results');

    if (searchInput && resultsContainer) {
      let pagefind: any = null;
      let debounceTimer: number;

      searchInput.addEventListener('input', async (e) => {
        const query = (e.target as HTMLInputElement).value;

        // Clear previous timer
        clearTimeout(debounceTimer);

        if (!query || query.length < 2) {
          resultsContainer.innerHTML = '';
          resultsContainer.classList.add('hidden');
          return;
        }

        // Debounce search
        debounceTimer = window.setTimeout(async () => {
          // Load Pagefind on first search
          if (!pagefind) {
            pagefind = await loadPagefind();
          }

          const search = await pagefind.search(query);

          if (search.results.length === 0) {
            resultsContainer.innerHTML = '<p class="text-sm text-slate-400 px-3 py-2">No results found</p>';
            resultsContainer.classList.remove('hidden');
            return;
          }

          // Render results
          const resultsHTML = await Promise.all(
            search.results.slice(0, 5).map(async (result: any) => {
              const data = await result.data();
              return `
                <a
                  href="${data.url}"
                  class="block p-3 bg-[#1e232f] hover:bg-[#292e3b] rounded-lg border border-[#292e3b] hover:border-indigo-500 transition-all"
                >
                  <div class="font-medium text-white text-sm mb-1">${data.meta.title || 'Untitled'}</div>
                  <div class="text-xs text-slate-400 line-clamp-2">${data.excerpt || ''}</div>
                </a>
              `;
            })
          );

          resultsContainer.innerHTML = resultsHTML.join('');
          resultsContainer.classList.remove('hidden');
        }, 300);
      });

      // Close results when clicking outside
      document.addEventListener('click', (e) => {
        if (!document.getElementById('pagefind-search')?.contains(e.target as Node)) {
          resultsContainer.classList.add('hidden');
        }
      });

      // Handle escape key
      searchInput.addEventListener('keydown', (e) => {
        if (e.key === 'Escape') {
          resultsContainer.classList.add('hidden');
          searchInput.blur();
        }
      });
    }
  } else {
    // Development mode fallback
    const searchInput = document.getElementById('pagefind-search-input') as HTMLInputElement;
    const resultsContainer = document.getElementById('pagefind-results');

    if (searchInput && resultsContainer) {
      searchInput.addEventListener('focus', () => {
        resultsContainer.innerHTML = '<p class="text-sm text-slate-400 px-3 py-2">Search is only available in production builds. Run <code class="px-2 py-1 bg-surface-800 rounded text-primary">npm run build</code> to test.</p>';
        resultsContainer.classList.remove('hidden');
      });
    }
  }
</script>

<style>
  #pagefind-results::-webkit-scrollbar {
    width: 6px;
  }

  #pagefind-results::-webkit-scrollbar-thumb {
    background: var(--color-surface-700);
    border-radius: 3px;
  }

  .line-clamp-2 {
    display: -webkit-box;
    -webkit-line-clamp: 2;
    -webkit-box-orient: vertical;
    overflow: hidden;
  }
</style>
