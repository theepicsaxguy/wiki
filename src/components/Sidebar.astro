---
import { getCollection } from 'astro:content';
import PagefindSearch from './PagefindSearch.astro';
import Icon from './Icon.astro';
import { buildNavigationTree, isActivePage, isParentOfActivePage } from '../utils/navigation';

// Get all docs pages
const allDocs = await getCollection('docs');

const navigation = buildNavigationTree(allDocs);

// Get current page
const currentPath = Astro.url.pathname.replace('/docs/', '').replace(/\/$/, '');

const isActive = (slug: string) => isActivePage(currentPath, slug);
const isParent = (slug: string) => isParentOfActivePage(currentPath, slug);
const isHome = Astro.url.pathname === '/';
---

<!-- Search Bar -->
<div class="mb-6">
  <PagefindSearch />
</div>

<!-- Wiki Home Link (only when on docs pages) -->
<div class="mb-6">
  <a
    href="/"
    class:list={[
      "group block px-3 py-2 rounded-xl text-sm font-medium transition-all",
      isHome
        ? "bg-primary text-white"
        : "text-text-muted hover:text-white hover:bg-surface"
    ]}
  >
    <span class="flex items-center gap-3">
      <Icon name="home" size={16} />
      <span>Wiki Home</span>
    </span>
  </a>
</div>

<div class="mb-3 flex items-center gap-2 px-3">
  <Icon name="folder" size={16} class="text-text-subtle" />
  <span class="text-xs font-semibold text-text-subtle uppercase tracking-wider">Documentation</span>
</div>

<nav aria-label="Documentation navigation">
  <ul class="space-y-1">
    {navigation.map(node => {
      const active = isActive(node.slug);
      const isParentNode = isParent(node.slug);
      const hasChildren = node.children.length > 0;

      return (
        <li>
          <a
            href={`/docs/${node.slug}`}
            class:list={[
              "group relative block px-3 py-2 rounded-xl text-sm font-medium transition-all",
              active
                ? "bg-primary text-white border-l-2 border-primary"
                : isParentNode
                ? "text-white bg-surface border-l-2 border-primary/50"
                : "text-text-muted hover:text-white hover:bg-surface hover:border-l-2 hover:border-primary/30"
            ]}
          >
            <span class="flex items-center gap-2">
              {hasChildren && (
                <Icon name="folder" size={16} class="text-text-muted group-hover:text-primary transition-colors" />
              )}
              {node.title}
            </span>
          </a>

          {hasChildren && (
            <ul class="mt-1 ml-4 pl-3 border-l border-border space-y-1">
              {node.children.filter(child => !child.slug.endsWith('/index')).map(child => {
                const childActive = isActive(child.slug);
                const childIsParent = isParent(child.slug);
                const childHasChildren = child.children.length > 0;

                return (
                  <li class="relative">
                    {/* Simple depth indicator */}
                    <div class="absolute left-0 top-0 bottom-0 w-px bg-border" aria-hidden="true"></div>
                    
                    <a
                      href={`/docs/${child.slug}`}
                      class:list={[
                        "group relative block px-3 py-1.5 rounded-xl text-sm transition-all",
                        childActive
                          ? "text-white font-medium bg-primary/10 border-l-2 border-primary"
                          : childIsParent
                          ? "text-white bg-surface/50 border-l-2 border-primary/30"
                          : "text-text-muted hover:text-white hover:bg-surface/30 hover:border-l-2 hover:border-primary/20"
                      ]}
                    >
                      <span class="flex items-center gap-1.5">
                        <span class="text-primary/60">▹</span>
                        {child.title}
                      </span>
                    </a>

                    {childHasChildren && (
                      <ul class="mt-1 ml-4 pl-3 border-l border-border space-y-1">
                        {child.children.filter(grandchild => !grandchild.slug.endsWith('/index')).map(grandchild => {
                          const grandchildActive = isActive(grandchild.slug);

                          return (
                            <li class="relative">
                              <a
                                href={`/docs/${grandchild.slug}`}
                                class:list={[
                                  "group relative block px-3 py-1.5 rounded-xl text-sm transition-all",
                                  grandchildActive
                                    ? "text-white font-medium bg-primary/10 border-l-2 border-primary"
                                    : "text-text-muted hover:text-white hover:bg-surface/30 hover:border-l-2 hover:border-primary/20"
                                ]}
                              >
                                <span class="flex items-center gap-1.5">
                                  <span class="text-primary/40">◦</span>
                                  {grandchild.title}
                                </span>
                              </a>
                            </li>
                          );
                        })}
                      </ul>
                    )}
                  </li>
                );
              })}
            </ul>
          )}
        </li>
      );
    })}
  </ul>
</nav>
