---
import { getCollection } from 'astro:content';
import PagefindSearch from './PagefindSearch.astro';
import { buildNavigationTree, isActivePage, isParentOfActivePage } from '../utils/navigation';

// Get all docs pages
const allDocs = await getCollection('docs');

const navigation = buildNavigationTree(allDocs);

// Get current page
const currentPath = Astro.url.pathname.replace('/docs/', '').replace(/\/$/, '');

const isActive = (slug: string) => isActivePage(currentPath, slug);
const isParent = (slug: string) => isParentOfActivePage(currentPath, slug);

// Top-level navigation items
const topNavItems = [
  { name: 'Wiki Home', path: '/' },
  { name: 'Getting Started', path: '/docs/user/getting-started' },
  { name: 'Rules', path: '/docs/policies/rules' },
  { name: 'Privacy', path: '/docs/legal/privacy' },
];
---

<!-- Search Bar -->
<div class="mb-6">
  <PagefindSearch />
</div>

<!-- Top-Level Navigation -->
<nav aria-label="Main navigation" class="mb-6 pb-6 border-b border-border">
  <ul class="space-y-1">
    {topNavItems.map(item => {
      const active = Astro.url.pathname === item.path;
      return (
        <li>
          <a
            href={item.path}
            class:list={[
              "block px-3 py-3 md:py-2 rounded-md text-sm font-medium transition-colors",
              active
                ? "bg-primary text-white"
                : "text-text-muted hover:text-white hover:bg-surface-800"
            ]}
          >
            {item.name}
          </a>
        </li>
      );
    })}
  </ul>
</nav>

<nav aria-label="Documentation navigation">
  <ul class="space-y-1">
    {navigation.map(node => {
      const active = isActive(node.slug);
      const isParentNode = isParent(node.slug);
      const hasChildren = node.children.length > 0;

      return (
        <li>
          <a
            href={`/docs/${node.slug}`}
            class:list={[
              "block px-3 py-3 md:py-2 rounded-md text-sm font-medium transition-colors",
              active
                ? "bg-primary text-white"
                : isParentNode
                ? "text-white"
                : "text-text-muted hover:text-white"
            ]}
          >
            <span class="flex items-center gap-2">
              {hasChildren && (
                <svg
                  class="w-4 h-4 text-slate-400"
                  fill="none"
                  viewBox="0 0 24 24"
                  stroke="currentColor"
                  aria-hidden="true"
                >
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 7v10a2 2 0 002 2h14a2 2 0 002-2V9a2 2 0 00-2-2h-6l-2-2H5a2 2 0 00-2 2z" />
                </svg>
              )}
              {node.title}
            </span>
          </a>

          {hasChildren && (
            <ul class="mt-1 ml-2 md:ml-4 pl-2 md:pl-4 border-l-2 border-border space-y-1">
              {node.children.filter(child => !child.slug.endsWith('/index')).map(child => {
                const childActive = isActive(child.slug);
                const childIsParent = isParent(child.slug);
                const childHasChildren = child.children.length > 0;

                return (
                  <li>
                    <a
                      href={`/docs/${child.slug}`}
                      class:list={[
                        "block px-3 py-3 md:py-1.5 rounded-md text-sm transition-colors",
                        childActive
                          ? "text-white font-medium bg-primary"
                          : childIsParent
                          ? "text-white"
                          : "text-text-muted hover:text-white"
                      ]}
                    >
                      {child.title}
                    </a>

                    {childHasChildren && (
                      <ul class="mt-1 ml-2 md:ml-4 pl-2 md:pl-4 border-l-2 border-border space-y-1">
                        {child.children.filter(grandchild => !grandchild.slug.endsWith('/index')).map(grandchild => {
                          const grandchildActive = isActive(grandchild.slug);

                          return (
                            <li>
                              <a
                                href={`/docs/${grandchild.slug}`}
                                class:list={[
                                  "block px-3 py-3 md:py-1.5 rounded-md text-sm transition-colors",
                                  grandchildActive
                                    ? "text-white font-medium bg-primary"
                                    : "text-text-muted hover:text-white"
                                ]}
                              >
                                {grandchild.title}
                              </a>
                            </li>
                          );
                        })}
                      </ul>
                    )}
                  </li>
                );
              })}
            </ul>
          )}
        </li>
      );
    })}
  </ul>
</nav>
